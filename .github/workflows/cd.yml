name: CD to VPS (Self-Hosted)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    environment: production

    env:
      SERVICE_NAME: smartcanopy-website
      VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
      VITE_MQTT_BROKER_URL: ${{ secrets.VITE_MQTT_BROKER_URL }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Prepare .env File
        shell: bash
        run: |
          set -euo pipefail
          echo "Creating .env file from secrets..."
          cat << EOF > .env
          VITE_API_BASE_URL=${VITE_API_BASE_URL}
          VITE_MQTT_BROKER_URL=${VITE_MQTT_BROKER_URL}
          EOF
          echo ".env file ready"

      - name: Stop and Remove Old Containers
        run: |
          set -euo pipefail
          echo "Stopping and removing existing containers..."
          docker compose down --remove-orphans

      - name: Clean Dangling Images (Pre-Build)
        run: |
          set -euo pipefail
          echo "Pruning dangling images before build..."
          docker image prune -f

      - name: Build Services
        run: |
          set -euo pipefail
          echo "Building services with docker compose..."
          docker compose build --pull

      - name: Start Services
        run: |
          set -euo pipefail
          echo "Starting services in detached mode..."
          docker compose up -d

      - name: Verify Deployment and Check Logs
        run: |
          set -euo pipefail
          echo "Waiting 15s for services to initialize..."
          sleep 15

          echo "Checking container status for '$SERVICE_NAME'..."
          if ! docker ps | grep -q "$SERVICE_NAME"; then
            echo "Error: '$SERVICE_NAME' container is not running."
            echo "Dumping logs for potential crash..."
            docker compose logs $SERVICE_NAME || echo "Could not fetch logs."
            exit 1
          fi
          echo "Service '$SERVICE_NAME' is running."

          echo "Checking logs for startup errors..."
          if docker compose logs --tail="100" $SERVICE_NAME | grep -i -E "error|exception|failed|crash"; then
            echo "Error detected in '$SERVICE_NAME' startup logs!"
            echo "Dumping full logs:"
            docker compose logs $SERVICE_NAME
            exit 1
          else
            echo "No immediate errors found in logs. Deployment successful."
            docker ps
          fi

      - name: Clean Dangling Images (Post-Deploy)
        run: |
          set -euo pipefail
          echo "Pruning dangling images after successful deployment..."
          docker image prune -f

      - name: Deployment Complete
        run: echo "Deployment process finished."
